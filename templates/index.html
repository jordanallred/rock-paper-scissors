<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Paper Scissors AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0b2341;
            --primary-dark: #233954;
            --secondary: #e86100;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--neutral-800);
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
            background-color: var(--neutral-100);
        }

        h1, h2, h3 {
            color: var(--neutral-900);
            line-height: 1.2;
        }

        h1 {
            font-size: 2.25rem;
            text-align: center;
            margin-bottom: 0.5rem;
            background: var(--secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
            position: relative;
        }

        h2::after {
            content: '';
            display: block;
            width: 50px;
            height: 3px;
            background: var(--secondary);
            margin: 0.5rem auto 0;
            border-radius: 999px;
        }

        h3 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .header-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .prediction-info {
            font-size: 1.125rem;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--neutral-800);
        }

        .game-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .game-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .game-panel > h2 {
            flex-shrink: 0;
            margin-bottom: 1rem;
        }

        .history-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .game-panel:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .move-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            width: 100%;
        }

        .move-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            font-size: 1.125rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }

        .move-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .move-button:active {
            transform: translateY(0);
        }

        .reset-button {
            background-color: var(--neutral-200);
            color: var(--neutral-800);
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .reset-button:hover {
            background-color: var(--neutral-300);
            box-shadow: var(--shadow);
        }

        .current-round {
            margin-bottom: 1.5rem;
        }

        .move-display {
            display: flex;
            justify-content: space-around;
            margin: 1.5rem 0;
        }

        .move-box {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: var(--neutral-100);
            width: 110px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }

        .move-box:hover {
            transform: scale(1.05);
        }

        .move-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            transition: transform 0.3s;
        }

        .move-box:hover .move-icon {
            transform: rotate(10deg);
        }

        #resultDisplay {
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            margin: 1rem 0;
            min-height: 1.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .result-win {
            color: var(--success);
            background-color: rgba(16, 185, 129, 0.1);
        }

        .result-lose {
            color: var(--danger);
            background-color: rgba(239, 68, 68, 0.1);
        }

        .result-tie {
            color: var(--warning);
            background-color: rgba(245, 158, 11, 0.1);
        }

        .scores {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
            padding: 1rem;
            background-color: var(--neutral-100);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .score-box {
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: transform 0.2s;
        }

        .score-box:hover {
            transform: translateY(-3px);
        }

        .score-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .history {
            max-height: 650px;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-top: 1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-300) transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 250px;
        }

        .game-panel:nth-child(2) {
            display: flex;
            flex-direction: column;
        }

        .game-panel:nth-child(2) h2 {
            flex-shrink: 0;
        }

        .history::-webkit-scrollbar {
            width: 6px;
        }

        .history::-webkit-scrollbar-track {
            background: transparent;
        }

        .history::-webkit-scrollbar-thumb {
            background-color: var(--neutral-300);
            border-radius: 6px;
        }

        .history-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--neutral-200);
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: var(--neutral-100);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .chart-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chart-panel:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        #heatmapContainer {
            margin-top: 1rem;
            overflow-x: auto;
        }

        #heatmapContainer table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        #heatmapContainer th {
            background-color: var(--neutral-100);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        #heatmapContainer td {
            padding: 0.75rem;
            transition: opacity 0.2s;
        }

        #heatmapContainer tr:hover td {
            opacity: 0.9;
        }

        .prediction-info {
            text-align: center;
            margin-top: 0.5rem;
            font-style: italic;
            color: var(--neutral-800);
            background-color: var(--neutral-100);
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        #patternsList ul {
            list-style: none;
            padding: 0;
        }

        #patternsList li {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background-color: var(--neutral-100);
            border-radius: 0.5rem;
            transition: transform 0.2s;
        }

        #patternsList li:hover {
            transform: translateX(3px);
        }

        @media (max-width: 768px) {
            .game-container, .charts-container {
                grid-template-columns: 1fr;
            }

            .move-buttons {
                flex-direction: column;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .game-panel, .chart-panel {
            animation: fadeIn 0.5s ease-out, slideUp 0.5s ease-out;
        }

        .game-panel:nth-child(2) {
            animation-delay: 0.1s;
        }

        .chart-panel:nth-child(1) {
            animation-delay: 0.2s;
        }

        .chart-panel:nth-child(2) {
            animation-delay: 0.3s;
        }

        .chart-panel:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>

</head>
<body>
<div class="header-container">
    <h1>Rock Paper Scissors AI</h1>
    <p class="prediction-info">The AI learns your patterns and tries to predict your next move!</p>
</div>

<div class="game-container">
    <div class="game-panel">
        <div class="current-round">
            <h2>Current Round</h2>
            <div class="move-display">
                <div class="move-box">
                    <div class="move-icon" id="userMoveIcon">?</div>
                    <div>You</div>
                </div>
                <div class="move-box">
                    <div class="move-icon" id="aiMoveIcon">?</div>
                    <div>AI</div>
                </div>
            </div>
            <div id="resultDisplay">Choose your move!</div>
            <div id="confidenceDisplay" class="prediction-info"></div>
            <div id="strategyDisplay" class="prediction-info"></div>
        </div>

        <div class="controls">
            <div class="move-buttons">
                <button class="move-button" data-move="rock"><span class="move-icon-small">✊</span> Rock</button>
                <button class="move-button" data-move="paper"><span class="move-icon-small">✋</span> Paper</button>
                <button class="move-button" data-move="scissors"><span class="move-icon-small">✌️</span> Scissors
                </button>
            </div>
            <button class="reset-button" id="resetButton">Reset Game</button>
        </div>

        <div class="scores">
            <div class="score-box">
                <div class="score-value" id="userScore">{{ scores.user }}</div>
                <div>You</div>
            </div>
            <div class="score-box">
                <div class="score-value" id="tieScore">{{ scores.tie }}</div>
                <div>Ties</div>
            </div>
            <div class="score-box">
                <div class="score-value" id="aiScore">{{ scores.ai }}</div>
                <div>AI</div>
            </div>
        </div>
    </div>

    <div class="game-panel">
        <h2>Game History</h2>
        <div class="history-container">
            <div class="history" id="historyContainer">
                {% if rounds %}
                    {% for round in rounds %}
                        <div class="history-item">
                            <span>Round {{ loop.index }}: You played {{ round.user_move }}, AI played {{ round.ai_move }}</span>
                            <span class="result-{{ round.result }}">
                                {% if round.result == 'win' %}
                                    You won!
                                {% elif round.result == 'lose' %}
                                    AI won!
                                {% else %}
                                    Tie!
                                {% endif %}
                            </span>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="history-item">No rounds played yet.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="charts-container">
    <div class="chart-panel">
        <h2>Your Move Frequencies</h2>
        <canvas id="moveChart"></canvas>
    </div>

    <div class="chart-panel">
        <h2>Pattern Analysis</h2>
        <div id="heatmapContainer"></div>
    </div>

    <div class="chart-panel">
        <h2>AI Analysis</h2>
        <div id="strategyAnalysisContainer">
            <h3>Detected Patterns</h3>
            <div id="patternsList"></div>
        </div>
    </div>
</div>

<script>

    const moveIcons = {
        'rock': '✊',
        'paper': '✋',
        'scissors': '✌️'
    };

    let moveChart = null;


    const moveData = {
        labels: ['Rock', 'Paper', 'Scissors'],
        datasets: [{
            label: 'Move Frequency',
            data: [0, 0, 0],
            backgroundColor: [
                'rgba(54, 162, 235, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 99, 132, 0.6)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1
        }]
    };


    document.addEventListener('DOMContentLoaded', function () {
        initGame();
        addEventListeners();
    });


    function initGame() {

        try {
            initMoveChart();
        } catch (err) {
            console.warn("Could not initialize chart:", err);
            document.getElementById('moveChart').innerHTML =
                '<p>Chart visualization not available</p>';
        }


        document.getElementById('heatmapContainer').innerHTML =
            '<p>Not enough data to display patterns yet.</p>';
        document.getElementById('patternsList').innerHTML =
            '<p>Not enough data to analyze patterns yet.</p>';
    }


    function addEventListeners() {

        document.querySelectorAll('.move-button').forEach(button => {
            button.addEventListener('click', function () {
                const move = this.getAttribute('data-move');
                playMove(move);
            });
        });


        document.getElementById('resetButton').addEventListener('click', function () {
            resetGame();
        });
    }


    function initMoveChart() {
        if (typeof Chart === 'undefined') {
            throw new Error("Chart.js library not available");
        }

        const ctx = document.getElementById('moveChart').getContext('2d');
        moveChart = new Chart(ctx, {
            type: 'bar',
            data: moveData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.raw.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }


    function updateMoveChart(frequencies) {
        try {
            if (!moveChart) {
                initMoveChart();
            }

            moveChart.data.datasets[0].data = [
                frequencies.rock * 100 || 0,
                frequencies.paper * 100 || 0,
                frequencies.scissors * 100 || 0
            ];
            moveChart.update();
        } catch (err) {
            console.warn("Could not update chart:", err);
        }
    }


    function updateHeatmap(transitions) {
        const container = document.getElementById('heatmapContainer');
        container.innerHTML = '';

        if (!transitions || Object.keys(transitions).length === 0) {
            container.innerHTML = '<p>Not enough data to display patterns yet.</p>';
            return;
        }


        let table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';


        let thead = document.createElement('thead');
        let headerRow = document.createElement('tr');

        let cornerCell = document.createElement('th');
        cornerCell.textContent = 'Pattern → Next';
        cornerCell.style.padding = '8px';
        cornerCell.style.borderBottom = '1px solid #ddd';
        headerRow.appendChild(cornerCell);

        ['Rock', 'Paper', 'Scissors'].forEach(move => {
            let th = document.createElement('th');
            th.textContent = move;
            th.style.padding = '8px';
            th.style.borderBottom = '1px solid #ddd';
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);


        let tbody = document.createElement('tbody');

        Object.entries(transitions).forEach(([pattern, counts]) => {
            let row = document.createElement('tr');


            let labelCell = document.createElement('td');
            labelCell.textContent = pattern;
            labelCell.style.padding = '8px';
            labelCell.style.borderBottom = '1px solid #ddd';
            row.appendChild(labelCell);


            const total = counts.rock + counts.paper + counts.scissors || 0;


            ['rock', 'paper', 'scissors'].forEach(move => {
                let cell = document.createElement('td');
                const count = counts[move] || 0;
                const percentage = total ? (count / total * 100).toFixed(1) : 0;


                const intensity = Math.min(0.9, count / (total || 1));
                const backgroundColor = move === 'rock'
                    ? `rgba(54, 162, 235, ${intensity})`
                    : move === 'paper'
                        ? `rgba(75, 192, 192, ${intensity})`
                        : `rgba(255, 99, 132, ${intensity})`;

                cell.textContent = `${count} (${percentage}%)`;
                cell.style.padding = '8px';
                cell.style.textAlign = 'center';
                cell.style.backgroundColor = backgroundColor;
                cell.style.color = intensity > 0.6 ? 'white' : 'black';
                cell.style.borderBottom = '1px solid #ddd';
                row.appendChild(cell);
            });

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
    }


    function updateStrategyAnalysis(strategyStats) {
        const container = document.getElementById('patternsList');
        container.innerHTML = '';


        if (!strategyStats || !strategyStats.patterns || Object.keys(strategyStats.patterns).length === 0) {
            container.innerHTML = '<p>Not enough data to analyze patterns yet.</p>';
            return;
        }


        const patternsList = document.createElement('ul');
        patternsList.style.listStyleType = 'none';
        patternsList.style.padding = '0';

        Object.entries(strategyStats.patterns).forEach(([pattern, stats]) => {
            const listItem = document.createElement('li');
            listItem.style.padding = '8px';
            listItem.style.margin = '5px 0';
            listItem.style.backgroundColor = 'rgba(0,0,0,0.05)';
            listItem.style.borderRadius = '4px';


            const colorValue = Math.floor(stats.strength * 255);
            const confidenceColor = `rgb(${255 - colorValue}, ${colorValue}, 0)`;

            listItem.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${pattern}</strong>
                        <span style="color:${confidenceColor}; font-weight:bold;">${(stats.strength * 100).toFixed(1)}%</span>
                    </div>
                    <div style="font-size:0.8em; color:#666;">
                        Observed ${stats.count} time${stats.count !== 1 ? 's' : ''}
                    </div>
                `;

            patternsList.appendChild(listItem);
        });

        container.appendChild(patternsList);
    }


    function updateHistory(data) {
        const historyContainer = document.getElementById('historyContainer');
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';

        const moveText = document.createElement('span');
        moveText.textContent = `Round ${historyContainer.children.length + 1}: You played ${data.user_move}, AI played ${data.ai_move} `;

        const resultText = document.createElement('span');
        resultText.className = `result-${data.result}`;
        if (data.result === 'win') {
            resultText.textContent = 'You won!';
        } else if (data.result === 'lose') {
            resultText.textContent = 'AI won!';
        } else {
            resultText.textContent = 'Tie!';
        }

        historyItem.appendChild(moveText);
        historyItem.appendChild(resultText);


        if (data.strategy) {
            const strategyText = document.createElement('div');
            strategyText.textContent = `AI strategy: ${data.strategy}`;
            strategyText.style.fontSize = '0.8em';
            strategyText.style.color = '#666';
            historyItem.appendChild(strategyText);
        }


        if (historyContainer.firstChild) {
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);

            if (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        } else {
            historyContainer.appendChild(historyItem);
        }
    }


    function playMove(move) {
        const formData = new FormData();
        formData.append('move', move);

        fetch('/play', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                try {

                    document.getElementById('userMoveIcon').textContent = moveIcons[data.user_move];
                    document.getElementById('aiMoveIcon').textContent = moveIcons[data.ai_move];


                    let resultText = '';
                    let resultClass = '';
                    if (data.result === 'win') {
                        resultText = 'You won!';
                        resultClass = 'result-win';
                    } else if (data.result === 'lose') {
                        resultText = 'AI won!';
                        resultClass = 'result-lose';
                    } else {
                        resultText = 'It\'s a tie!';
                        resultClass = 'result-tie';
                    }
                    document.getElementById('resultDisplay').textContent = resultText;
                    document.getElementById('resultDisplay').className = resultClass;


                    document.getElementById('confidenceDisplay').textContent =
                        `AI confidence: ${data.confidence}%`;

                    if (data.strategy) {
                        document.getElementById('strategyDisplay').textContent =
                            `Strategy: ${data.strategy}`;
                    }


                    document.getElementById('userScore').textContent = data.scores.user;
                    document.getElementById('aiScore').textContent = data.scores.ai;
                    document.getElementById('tieScore').textContent = data.scores.tie;


                    updateHistory(data);


                    if (data.move_frequencies) {
                        updateMoveChart(data.move_frequencies);
                    }

                    if (data.transitions) {
                        updateHeatmap(data.transitions);
                    }

                    if (data.strategy_stats) {
                        updateStrategyAnalysis(data.strategy_stats);
                    }

                } catch (err) {
                    console.warn("Error updating UI:", err);

                }
            })
            .catch(err => {
                console.error("Error playing move:", err);

                if (document.getElementById('userMoveIcon').textContent === '?' ||
                    document.getElementById('aiMoveIcon').textContent === '?') {
                    alert('Error playing move. Please try again.');
                }
            });
    }


    function resetGame() {
        fetch('/reset', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {

                document.getElementById('userMoveIcon').textContent = '?';
                document.getElementById('aiMoveIcon').textContent = '?';
                document.getElementById('resultDisplay').textContent = 'Choose your move!';
                document.getElementById('resultDisplay').className = '';
                document.getElementById('confidenceDisplay').textContent = '';
                document.getElementById('strategyDisplay').textContent = '';


                document.getElementById('userScore').textContent = '0';
                document.getElementById('aiScore').textContent = '0';
                document.getElementById('tieScore').textContent = '0';


                document.getElementById('historyContainer').innerHTML =
                    '<div class="history-item">No rounds played yet.</div>';


                try {
                    if (moveChart) {
                        moveChart.data.datasets[0].data = [0, 0, 0];
                        moveChart.update();
                    }
                } catch (err) {
                    console.warn("Error resetting chart:", err);
                }

                document.getElementById('heatmapContainer').innerHTML =
                    '<p>Not enough data to display patterns yet.</p>';
                document.getElementById('patternsList').innerHTML =
                    '<p>Not enough data to analyze patterns yet.</p>';

                alert('Game has been reset!');
            })
            .catch(err => {
                console.error("Error resetting game:", err);
                alert('Error resetting game. Please try again.');
            });
    }
</script>
</body>
</html>